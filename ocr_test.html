<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCRè®ºæ–‡ä¿¡æ¯è¯†åˆ«æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #667eea;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }

        .preview-section {
            margin-top: 30px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .result-value {
            font-size: 16px;
            color: #333;
            word-break: break-word;
        }

        .result-value.empty {
            color: #999;
            font-style: italic;
        }

        .dates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .date-item {
            padding: 10px;
            background: #f8f9ff;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .date-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .date-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #c33;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #3c3;
        }

        .raw-text {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .toggle-raw {
            margin-top: 10px;
            font-size: 14px;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .toggle-raw:hover {
            color: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ OCRè®ºæ–‡ä¿¡æ¯è¯†åˆ«æµ‹è¯•</h1>
            <p>ä¸Šä¼ PDFæˆ–å›¾ç‰‡æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯†åˆ«è®ºæ–‡æ ‡é¢˜ã€ä½œè€…å’Œæ—¥æœŸä¿¡æ¯</p>
        </div>

        <div class="content">
            <!-- APIé…ç½®åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">âš™ï¸ APIé…ç½®</div>
                <div class="config-grid">
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="apiBaseUrl" value="https://api.tokenpony.cn/v1" placeholder="https://api.tokenpony.cn/v1">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="text" id="apiKey" value="" placeholder="è¾“å…¥ä½ çš„API Key">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <input type="text" id="modelName" value="deepseek-ocr" placeholder="deepseek-ocr">
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">ğŸ“¤ æ–‡ä»¶ä¸Šä¼ </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                    <div class="upload-hint">æ”¯æŒ PDFã€JPGã€PNG ç­‰æ ¼å¼</div>
                </div>
                <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.bmp,.gif">
                <div class="btn-group">
                    <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                    <button class="btn" id="recognizeBtn" disabled>å¼€å§‹è¯†åˆ«</button>
                    <button class="btn btn-secondary" id="clearBtn">æ¸…ç©º</button>
                </div>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-section" id="previewSection" style="display: none;">
                <div class="section-title">ğŸ‘ï¸ æ–‡ä»¶é¢„è§ˆ</div>
                <img id="previewImage" class="preview-image" alt="é¢„è§ˆ">
            </div>

            <!-- è¯†åˆ«ç»“æœåŒºåŸŸ -->
            <div id="resultSection" style="display: none;">
                <div class="section-title">ğŸ“Š è¯†åˆ«ç»“æœ</div>
                <div class="result-section" id="resultContent"></div>
            </div>

            <!-- é”™è¯¯/æˆåŠŸæ¶ˆæ¯ -->
            <div id="messageArea"></div>
        </div>
    </div>

    <!-- å¼•å…¥PDF.jsåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // åˆå§‹åŒ–PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const previewSection = document.getElementById('previewSection');
        const previewImage = document.getElementById('previewImage');
        const resultSection = document.getElementById('resultSection');
        const resultContent = document.getElementById('resultContent');
        const messageArea = document.getElementById('messageArea');

        // å½“å‰æ–‡ä»¶
        let currentFile = null;
        let currentImageData = null;

        // ç»‘å®šäº‹ä»¶
        uploadArea.addEventListener('click', () => fileInput.click());
        selectFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        recognizeBtn.addEventListener('click', handleRecognize);
        clearBtn.addEventListener('click', handleClear);

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // å¤„ç†æ–‡ä»¶
        async function handleFile(file) {
            console.log('=== å¼€å§‹å¤„ç†æ–‡ä»¶ ===');
            console.log('æ–‡ä»¶å:', file.name);
            console.log('æ–‡ä»¶ç±»å‹:', file.type);
            console.log('æ–‡ä»¶å¤§å°:', (file.size / 1024).toFixed(2), 'KB');
            
            currentFile = file;
            recognizeBtn.disabled = false;
            showMessage('', '');

            // å¦‚æœæ˜¯PDFï¼Œè½¬æ¢ä¸ºå›¾ç‰‡
            if (file.type === 'application/pdf') {
                try {
                    console.log('[PDFå¤„ç†] å¼€å§‹åŠ è½½PDFæ–‡ä»¶...');
                    const arrayBuffer = await file.arrayBuffer();
                    console.log('[PDFå¤„ç†] PDFæ–‡ä»¶å·²åŠ è½½ï¼Œå¤§å°:', (arrayBuffer.byteLength / 1024).toFixed(2), 'KB');
                    
                    console.log('[PDFå¤„ç†] å¼€å§‹è§£æPDFæ–‡æ¡£...');
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    console.log('[PDFå¤„ç†] PDFæ–‡æ¡£è§£æå®Œæˆï¼Œæ€»é¡µæ•°:', pdf.numPages);
                    
                    console.log('[PDFå¤„ç†] å¼€å§‹æ¸²æŸ“ç¬¬ä¸€é¡µ...');
                    const page = await pdf.getPage(1); // åªå¤„ç†ç¬¬ä¸€é¡µ
                    const viewport = page.getViewport({ scale: 2 });
                    console.log('[PDFå¤„ç†] é¡µé¢å°ºå¯¸:', viewport.width, 'x', viewport.height);
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const context = canvas.getContext('2d');
                    
                    console.log('[PDFå¤„ç†] å¼€å§‹æ¸²æŸ“é¡µé¢åˆ°Canvas...');
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    console.log('[PDFå¤„ç†] é¡µé¢æ¸²æŸ“å®Œæˆ');

                    currentImageData = canvas.toDataURL('image/jpeg', 0.95);
                    const imageSize = (currentImageData.length * 3 / 4 / 1024).toFixed(2);
                    console.log('[PDFå¤„ç†] å›¾ç‰‡è½¬æ¢å®Œæˆï¼ŒBase64å¤§å°:', imageSize, 'KB');
                    console.log('[PDFå¤„ç†] å›¾ç‰‡MIMEç±»å‹: image/jpeg');
                    
                    previewImage.src = currentImageData;
                    previewSection.style.display = 'block';
                    console.log('=== æ–‡ä»¶å¤„ç†å®Œæˆ ===');
                } catch (error) {
                    console.error('[PDFå¤„ç†] å¤„ç†å¤±è´¥:', error);
                    console.error('[PDFå¤„ç†] é”™è¯¯å †æ ˆ:', error.stack);
                    showMessage('PDFå¤„ç†å¤±è´¥: ' + error.message, 'error');
                }
            } else if (file.type.startsWith('image/')) {
                // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œç›´æ¥æ˜¾ç¤º
                console.log('[å›¾ç‰‡å¤„ç†] å¼€å§‹è¯»å–å›¾ç‰‡æ–‡ä»¶...');
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageData = e.target.result;
                    const imageSize = (currentImageData.length * 3 / 4 / 1024).toFixed(2);
                    console.log('[å›¾ç‰‡å¤„ç†] å›¾ç‰‡è¯»å–å®Œæˆï¼ŒBase64å¤§å°:', imageSize, 'KB');
                    console.log('[å›¾ç‰‡å¤„ç†] å›¾ç‰‡MIMEç±»å‹:', file.type);
                    previewImage.src = currentImageData;
                    previewSection.style.display = 'block';
                    console.log('=== æ–‡ä»¶å¤„ç†å®Œæˆ ===');
                };
                reader.onerror = (error) => {
                    console.error('[å›¾ç‰‡å¤„ç†] è¯»å–å¤±è´¥:', error);
                    showMessage('å›¾ç‰‡è¯»å–å¤±è´¥', 'error');
                };
                reader.readAsDataURL(file);
            } else {
                console.warn('[æ–‡ä»¶å¤„ç†] ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼:', file.type);
                showMessage('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'error');
                currentFile = null;
                recognizeBtn.disabled = true;
            }
        }

        // å¤„ç†è¯†åˆ«
        async function handleRecognize() {
            console.log('=== å¼€å§‹OCRè¯†åˆ« ===');
            
            if (!currentImageData) {
                console.warn('[OCRè¯†åˆ«] é”™è¯¯: æ²¡æœ‰å¯è¯†åˆ«çš„å›¾ç‰‡æ•°æ®');
                showMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const modelName = document.getElementById('modelName').value.trim();

            console.log('[OCRè¯†åˆ«] APIé…ç½®:');
            console.log('  - Base URL:', apiBaseUrl);
            console.log('  - Model:', modelName);
            console.log('  - API Key:', apiKey ? apiKey.substring(0, 10) + '...' : '(æœªè®¾ç½®)');

            if (!apiBaseUrl || !apiKey || !modelName) {
                console.error('[OCRè¯†åˆ«] é”™è¯¯: APIé…ç½®ä¸å®Œæ•´');
                showMessage('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®', 'error');
                return;
            }

            recognizeBtn.disabled = true;
            recognizeBtn.innerHTML = '<span class="loading"></span>è¯†åˆ«ä¸­...';
            resultSection.style.display = 'none';
            showMessage('', '');

            try {
                // æå–base64æ•°æ®
                console.log('[OCRè¯†åˆ«] å¼€å§‹æå–å›¾ç‰‡æ•°æ®...');
                const base64Data = currentImageData.split(',')[1];
                const mimeType = currentImageData.match(/data:([^;]+);/)[1];
                const base64Size = (base64Data.length * 3 / 4 / 1024).toFixed(2);
                console.log('[OCRè¯†åˆ«] Base64æ•°æ®æå–å®Œæˆï¼Œå¤§å°:', base64Size, 'KB');
                console.log('[OCRè¯†åˆ«] MIMEç±»å‹:', mimeType);

                // OCRæç¤ºè¯ - æ›´æ˜ç¡®åœ°è¦æ±‚æå–å®é™…å†…å®¹
                const ocrPrompt = `è¯·ä»”ç»†é˜…è¯»å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å†…å®¹ï¼Œæå–è®ºæ–‡çš„å®é™…ä¿¡æ¯ã€‚

**é‡è¦ï¼šå¿…é¡»æå–å›¾ç‰‡ä¸­å®é™…å¯è§çš„æ–‡å­—å†…å®¹ï¼Œä¸è¦è¾“å‡ºç¤ºä¾‹æ–‡å­—ï¼**

è¯·æå–ï¼š
1. title: å›¾ç‰‡ä¸­å®é™…æ˜¾ç¤ºçš„è®ºæ–‡æ ‡é¢˜æ–‡å­—ï¼ˆé€šå¸¸æ˜¯é¡µé¢æœ€ä¸Šæ–¹çš„å¤§å­—ï¼‰
2. authors: å›¾ç‰‡ä¸­å®é™…æ˜¾ç¤ºçš„ç¬¬ä¸€ä½œè€…å§“åï¼ˆæ ‡é¢˜ä¸‹æ–¹ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªä½œè€…ï¼‰
3. dates.received: å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„æŠ•ç¨¿æ—¥æœŸï¼ˆæŸ¥æ‰¾"Received"ã€"Submitted"ã€"æŠ•ç¨¿"ç­‰å…³é”®è¯åçš„æ—¥æœŸï¼‰
4. dates.revised: å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„ä¿®æ”¹æ—¥æœŸï¼ˆæŸ¥æ‰¾"Revised"ã€"Revision"ã€"ä¿®æ”¹"ç­‰å…³é”®è¯åçš„æ—¥æœŸï¼‰
5. dates.accepted: å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„æ¥å—æ—¥æœŸï¼ˆæŸ¥æ‰¾"Accepted"ã€"Acceptance"ã€"æ¥å—"ç­‰å…³é”®è¯åçš„æ—¥æœŸï¼‰
6. dates.available_online: å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„åœ¨çº¿å‘è¡¨æ—¥æœŸï¼ˆæŸ¥æ‰¾"Available online"ã€"Published online"ã€"åœ¨çº¿å‘è¡¨"ç­‰å…³é”®è¯åçš„æ—¥æœŸï¼‰

**ä¸¥æ ¼è¦æ±‚ï¼š**
- å¿…é¡»è¾“å‡ºå›¾ç‰‡ä¸­å®é™…å­˜åœ¨çš„æ–‡å­—ï¼Œä¸è¦è¾“å‡º"è®ºæ–‡æ ‡é¢˜"ã€"ä½œè€…å§“å"ã€"æ—¥æœŸ"è¿™æ ·çš„ç¤ºä¾‹æ–‡å­—
- åªè¾“å‡ºJSONä»£ç å—ï¼Œä¸è¦å…¶ä»–ä»»ä½•æ–‡å­—
- æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DDï¼ˆå¦‚æœå›¾ç‰‡ä¸­æ˜¯å…¶ä»–æ ¼å¼ï¼Œè¯·è½¬æ¢ï¼‰
- å¦‚æœå›¾ç‰‡ä¸­æ‰¾ä¸åˆ°æŸé¡¹ä¿¡æ¯ï¼Œå¡«å†™ç©ºå­—ç¬¦ä¸²""
- æ ‡é¢˜å’Œä½œè€…è¦å»é™¤Markdownæ ¼å¼æ ‡è®°ï¼ˆå¦‚**ç²—ä½“**ï¼‰

**è¾“å‡ºæ ¼å¼ï¼ˆåªè¾“å‡ºè¿™ä¸ªJSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ï¼‰ï¼š**
\`\`\`json
{
  "title": "ä»å›¾ç‰‡ä¸­æå–çš„å®é™…æ ‡é¢˜æ–‡å­—",
  "authors": "ä»å›¾ç‰‡ä¸­æå–çš„å®é™…ç¬¬ä¸€ä½œè€…å§“å",
  "dates": {
    "received": "YYYY-MM-DDæˆ–ç©ºå­—ç¬¦ä¸²",
    "revised": "YYYY-MM-DDæˆ–ç©ºå­—ç¬¦ä¸²",
    "accepted": "YYYY-MM-DDæˆ–ç©ºå­—ç¬¦ä¸²",
    "available_online": "YYYY-MM-DDæˆ–ç©ºå­—ç¬¦ä¸²"
  }
}
\`\`\`

**å†æ¬¡å¼ºè°ƒï¼šå¿…é¡»æå–å›¾ç‰‡ä¸­çš„å®é™…æ–‡å­—å†…å®¹ï¼Œä¸è¦è¾“å‡ºç¤ºä¾‹ï¼**`;

                console.log('[OCRè¯†åˆ«] OCRæç¤ºè¯é•¿åº¦:', ocrPrompt.length, 'å­—ç¬¦');
                console.log('[OCRè¯†åˆ«] æç¤ºè¯å†…å®¹:', ocrPrompt);

                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    model: modelName,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: ocrPrompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: `data:${mimeType};base64,${base64Data}`
                                    }
                                }
                            ]
                        }
                    ],
                    temperature: 0,
                    max_tokens: 4000
                };

                const requestBodySize = JSON.stringify(requestBody).length;
                console.log('[OCRè¯†åˆ«] è¯·æ±‚ä½“å¤§å°:', (requestBodySize / 1024).toFixed(2), 'KB');
                console.log('[OCRè¯†åˆ«] è¯·æ±‚URL:', `${apiBaseUrl}/chat/completions`);
                console.log('[OCRè¯†åˆ«] è¯·æ±‚æ–¹æ³•: POST');
                console.log('[OCRè¯†åˆ«] è¯·æ±‚å‚æ•°:', {
                    model: modelName,
                    temperature: 0,
                    max_tokens: 2000,
                    messages_count: 1,
                    content_items: requestBody.messages[0].content.length
                });

                // è°ƒç”¨OCR API
                const startTime = Date.now();
                console.log('[OCRè¯†åˆ«] å¼€å§‹å‘é€APIè¯·æ±‚...', new Date().toISOString());
                
                const response = await fetch(`${apiBaseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const requestTime = Date.now() - startTime;
                console.log('[OCRè¯†åˆ«] APIè¯·æ±‚å®Œæˆï¼Œè€—æ—¶:', requestTime, 'ms');
                console.log('[OCRè¯†åˆ«] å“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('[OCRè¯†åˆ«] å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[OCRè¯†åˆ«] APIè¯·æ±‚å¤±è´¥:');
                    console.error('  - çŠ¶æ€ç :', response.status);
                    console.error('  - çŠ¶æ€æ–‡æœ¬:', response.statusText);
                    console.error('  - é”™è¯¯å†…å®¹:', errorText);
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`);
                }

                console.log('[OCRè¯†åˆ«] å¼€å§‹è§£æå“åº”æ•°æ®...');
                const data = await response.json();
                console.log('[OCRè¯†åˆ«] å“åº”æ•°æ®ç»“æ„:', {
                    id: data.id,
                    model: data.model,
                    choices_count: data.choices?.length || 0,
                    usage: data.usage
                });
                
                if (data.usage) {
                    console.log('[OCRè¯†åˆ«] Tokenä½¿ç”¨æƒ…å†µ:', {
                        prompt_tokens: data.usage.prompt_tokens,
                        completion_tokens: data.usage.completion_tokens,
                        total_tokens: data.usage.total_tokens
                    });
                }

                const content = data.choices?.[0]?.message?.content || '';
                console.log('[OCRè¯†åˆ«] è¯†åˆ«å†…å®¹é•¿åº¦:', content.length, 'å­—ç¬¦');
                console.log('[OCRè¯†åˆ«] è¯†åˆ«å†…å®¹é¢„è§ˆ:', content.substring(0, 200) + (content.length > 200 ? '...' : ''));
                console.log('[OCRè¯†åˆ«] å®Œæ•´è¯†åˆ«å†…å®¹:', content);

                // è§£æç»“æœ
                console.log('[OCRè¯†åˆ«] å¼€å§‹è§£æè¯†åˆ«ç»“æœ...');
                parseAndDisplayResult(content);
                console.log('=== OCRè¯†åˆ«å®Œæˆ ===');

            } catch (error) {
                console.error('=== OCRè¯†åˆ«å¤±è´¥ ===');
                console.error('[OCRè¯†åˆ«] é”™è¯¯ç±»å‹:', error.name);
                console.error('[OCRè¯†åˆ«] é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('[OCRè¯†åˆ«] é”™è¯¯å †æ ˆ:', error.stack);
                if (error.cause) {
                    console.error('[OCRè¯†åˆ«] é”™è¯¯åŸå› :', error.cause);
                }
                showMessage('è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
            } finally {
                recognizeBtn.disabled = false;
                recognizeBtn.innerHTML = 'å¼€å§‹è¯†åˆ«';
            }
        }

        // è§£æå¹¶æ˜¾ç¤ºç»“æœ
        function parseAndDisplayResult(content) {
            console.log('=== å¼€å§‹è§£æè¯†åˆ«ç»“æœ ===');
            console.log('[ç»“æœè§£æ] åŸå§‹å†…å®¹é•¿åº¦:', content.length, 'å­—ç¬¦');
            
            let result = {
                title: '',
                authors: '',
                dates: {
                    received: '',
                    revised: '',
                    accepted: '',
                    available_online: ''
                },
                rawText: content
            };

            // å°è¯•æå–JSON
            try {
                console.log('[ç»“æœè§£æ] å°è¯•æå–JSONæ ¼å¼æ•°æ®...');
                
                // æŸ¥æ‰¾JSONä»£ç å—
                const jsonMatch1 = content.match(/```json\s*([\s\S]*?)\s*```/);
                const jsonMatch2 = content.match(/```\s*([\s\S]*?)\s*```/);
                const jsonMatch3 = content.match(/\{[\s\S]*\}/);
                
                console.log('[ç»“æœè§£æ] JSONåŒ¹é…ç»“æœ:');
                console.log('  - ```jsonä»£ç å—:', jsonMatch1 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                console.log('  - ```ä»£ç å—:', jsonMatch2 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                console.log('  - æ™®é€šJSONå¯¹è±¡:', jsonMatch3 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
                
                const jsonMatch = jsonMatch1 || jsonMatch2 || jsonMatch3;
                
                if (jsonMatch) {
                    const jsonStr = jsonMatch[1] || jsonMatch[0];
                    console.log('[ç»“æœè§£æ] æå–çš„JSONå­—ç¬¦ä¸²é•¿åº¦:', jsonStr.length, 'å­—ç¬¦');
                    console.log('[ç»“æœè§£æ] JSONå­—ç¬¦ä¸²é¢„è§ˆ:', jsonStr.substring(0, 300) + (jsonStr.length > 300 ? '...' : ''));
                    
                    try {
                        const parsed = JSON.parse(jsonStr);
                        console.log('[ç»“æœè§£æ] JSONè§£ææˆåŠŸ');
                        console.log('[ç»“æœè§£æ] è§£æåçš„å¯¹è±¡:', parsed);
                        
                        if (parsed.title) {
                            result.title = parsed.title;
                            console.log('[ç»“æœè§£æ] âœ“ æå–åˆ°æ ‡é¢˜:', result.title);
                        } else {
                            console.log('[ç»“æœè§£æ] âœ— æœªæ‰¾åˆ°æ ‡é¢˜');
                        }
                        
                        if (parsed.authors) {
                            result.authors = parsed.authors;
                            console.log('[ç»“æœè§£æ] âœ“ æå–åˆ°ä½œè€…:', result.authors);
                        } else {
                            console.log('[ç»“æœè§£æ] âœ— æœªæ‰¾åˆ°ä½œè€…');
                        }
                        
                        if (parsed.dates) {
                            console.log('[ç»“æœè§£æ] æ—¥æœŸå¯¹è±¡:', parsed.dates);
                            if (parsed.dates.received) {
                                result.dates.received = parsed.dates.received;
                                console.log('[ç»“æœè§£æ] âœ“ æå–åˆ°æŠ•ç¨¿æ—¥æœŸ:', result.dates.received);
                            }
                            if (parsed.dates.revised) {
                                result.dates.revised = parsed.dates.revised;
                                console.log('[ç»“æœè§£æ] âœ“ æå–åˆ°ä¿®æ”¹æ—¥æœŸ:', result.dates.revised);
                            }
                            if (parsed.dates.accepted) {
                                result.dates.accepted = parsed.dates.accepted;
                                console.log('[ç»“æœè§£æ] âœ“ æå–åˆ°æ¥å—æ—¥æœŸ:', result.dates.accepted);
                            }
                            if (parsed.dates.available_online) {
                                result.dates.available_online = parsed.dates.available_online;
                                console.log('[ç»“æœè§£æ] âœ“ æå–åˆ°åœ¨çº¿å‘è¡¨æ—¥æœŸ:', result.dates.available_online);
                            }
                        } else {
                            console.log('[ç»“æœè§£æ] âœ— æœªæ‰¾åˆ°æ—¥æœŸä¿¡æ¯');
                        }
                    } catch (parseError) {
                        console.error('[ç»“æœè§£æ] JSONè§£æå¤±è´¥:', parseError);
                        console.error('[ç»“æœè§£æ] å°è¯•è§£æçš„JSONå­—ç¬¦ä¸²:', jsonStr);
                        throw parseError;
                    }
                } else {
                    console.log('[ç»“æœè§£æ] æœªæ‰¾åˆ°JSONæ ¼å¼ï¼Œå°è¯•æ–‡æœ¬æå–...');
                    extractFromText(content, result);
                }
            } catch (error) {
                console.warn('[ç»“æœè§£æ] JSONè§£æå¤±è´¥ï¼Œå°è¯•æ–‡æœ¬æå–:', error);
                console.warn('[ç»“æœè§£æ] é”™è¯¯è¯¦æƒ…:', error.message);
                extractFromText(content, result);
            }

            console.log('[ç»“æœè§£æ] æœ€ç»ˆè§£æç»“æœ:', result);
            console.log('=== ç»“æœè§£æå®Œæˆ ===');

            // æ˜¾ç¤ºç»“æœ
            displayResult(result);
        }

        // ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯
        function extractFromText(text, result) {
            console.log('[æ–‡æœ¬æå–] å¼€å§‹ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯...');
            console.log('[æ–‡æœ¬æå–] æ–‡æœ¬é•¿åº¦:', text.length, 'å­—ç¬¦');
            console.log('[æ–‡æœ¬æå–] åŸå§‹æ–‡æœ¬:', text);
            
            // æ£€æµ‹æ˜¯å¦æ˜¯ç¤ºä¾‹æ ¼å¼ï¼ˆæ¨¡å‹è¿”å›äº†ç¤ºä¾‹è€Œä¸æ˜¯å®é™…å†…å®¹ï¼‰
            const isExampleFormat = /è®ºæ–‡æ ‡é¢˜|ä½œè€…å§“å|æ—¥æœŸ[ï¼š:]\s*æ—¥æœŸ/i.test(text) && 
                                   text.split(/è®ºæ–‡æ ‡é¢˜|ä½œè€…å§“å|æ—¥æœŸ/).length > 10;
            
            if (isExampleFormat) {
                console.warn('[æ–‡æœ¬æå–] âš ï¸ æ£€æµ‹åˆ°ç¤ºä¾‹æ ¼å¼ï¼Œæ¨¡å‹å¯èƒ½æ²¡æœ‰æ­£ç¡®æå–å®é™…å†…å®¹');
                console.warn('[æ–‡æœ¬æå–] å»ºè®®ï¼šæ£€æŸ¥å›¾ç‰‡è´¨é‡æˆ–å°è¯•é‡æ–°è¯†åˆ«');
                // ä¸è¿›è¡Œæå–ï¼Œå› ä¸ºè¿™æ˜¯æ— æ•ˆçš„ç¤ºä¾‹æ ¼å¼
                return;
            }
            
            // æ¸…ç†æ–‡æœ¬ï¼šå»é™¤å¤šä½™ç©ºç™½ï¼Œåˆ†å‰²æˆè¡Œ
            const lines = text.split(/\r?\n/)
                .map(line => line.trim())
                .filter(line => line.length > 0);
            console.log('[æ–‡æœ¬æå–] æ–‡æœ¬è¡Œæ•°:', lines.length);
            console.log('[æ–‡æœ¬æå–] æ–‡æœ¬è¡Œå†…å®¹:', lines);

            // æå–æ ‡é¢˜ - å¤šç§ç­–ç•¥ï¼ˆä¼˜å…ˆMarkdownæ ¼å¼ï¼‰
            console.log('[æ–‡æœ¬æå–] å°è¯•æå–æ ‡é¢˜...');
            
            // ç­–ç•¥1: ä¼˜å…ˆè¯†åˆ«Markdownæ ¼å¼çš„æ ‡é¢˜ **æ ‡é¢˜**
            let titleFound = false;
            for (const line of lines) {
                // åŒ¹é… **æ ‡é¢˜** æ ¼å¼
                const markdownMatch = line.match(/^\*\*(.+?)\*\*$/);
                if (markdownMatch && markdownMatch[1]) {
                    const candidate = markdownMatch[1].trim();
                    // æ’é™¤æ˜æ˜¾ä¸æ˜¯æ ‡é¢˜çš„è¡Œï¼ˆå¦‚ä½œè€…ã€æœºæ„ç­‰ï¼‰
                    if (candidate.length > 10 && 
                        candidate.length < 300 &&
                        !/^(ARTICLE INFO|ABSTRACT|Introduction|References?|Keywords?)/i.test(candidate) &&
                        !/^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*(?:\s*,\s*[A-Z][a-z]+)+$/.test(candidate) && // æ’é™¤ä½œè€…æ ¼å¼
                        !/^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\s+et\s+al\.?$/i.test(candidate)) { // æ’é™¤et alæ ¼å¼
                        result.title = candidate;
                        console.log('[æ–‡æœ¬æå–] âœ“ ä»Markdownæ ¼å¼æå–åˆ°æ ‡é¢˜:', result.title);
                        titleFound = true;
                        break;
                    }
                }
            }
            
            // ç­–ç•¥2: è¯†åˆ«å¸¦æ ‡ç­¾çš„æ ‡é¢˜
            if (!titleFound) {
                const titlePatterns = [
                    /(?:æ ‡é¢˜|Title|è®ºæ–‡æ ‡é¢˜|Paper Title|Article Title)[:ï¼š]\s*(.+)/i,
                    /^Title[:ï¼š]\s*(.+)$/i,
                    /^æ ‡é¢˜[:ï¼š]\s*(.+)$/i
                ];
                
                for (let i = 0; i < titlePatterns.length && !titleFound; i++) {
                    const pattern = titlePatterns[i];
                    for (const line of lines) {
                        const match = line.match(pattern);
                        if (match && match[1]) {
                            result.title = match[1].trim();
                            console.log('[æ–‡æœ¬æå–] âœ“ ä½¿ç”¨æ ‡ç­¾æ¨¡å¼', i + 1, 'æå–åˆ°æ ‡é¢˜:', result.title);
                            titleFound = true;
                            break;
                        }
                    }
                }
            }
            
            // ç­–ç•¥3: æ™ºèƒ½è¯†åˆ«æ ‡é¢˜ï¼ˆæ’é™¤æ‘˜è¦ã€å¼•è¨€ç­‰ï¼‰
            if (!titleFound && lines.length > 0) {
                console.log('[æ–‡æœ¬æå–] å°è¯•æ™ºèƒ½è¯†åˆ«æ ‡é¢˜...');
                const datePattern = /^\d{4}[-å¹´/]\d{1,2}[-æœˆ/]\d{1,2}/;
                const excludeKeywords = [
                    /^(å›¾ç‰‡ä¸­çš„æ–‡å­—|---|ARTICLE INFO|ABSTRACT|Introduction|References?|Keywords?|ä½œè€…|Author|Received|Revised|Accepted|Available|Published)/i,
                    /^(The|This|These|In this|We|Our|Results?|Conclusion)/i, // æ‘˜è¦å¸¸è§å¼€å¤´
                    /^(å›¾ç‰‡|å›¾ç‰‡å†…å®¹|æ–‡å­—å†…å®¹)/i
                ];
                
                // è¿‡æ»¤å€™é€‰è¡Œï¼šæ’é™¤æ—¥æœŸã€æ ‡ç­¾ã€æ‘˜è¦ç­‰
                const candidateLines = lines.filter((line, index) => {
                    // è·³è¿‡å‰å‡ è¡Œï¼ˆå¯èƒ½æ˜¯è¯´æ˜æ–‡å­—ï¼‰
                    if (index < 2) return false;
                    
                    // æ’é™¤æ˜æ˜¾ä¸æ˜¯æ ‡é¢˜çš„è¡Œ
                    if (datePattern.test(line)) return false;
                    if (excludeKeywords.some(pattern => pattern.test(line))) return false;
                    if (line.startsWith('*') && line.endsWith('*')) return false; // æ’é™¤æ–œä½“æœºæ„å
                    if (line.length < 10) return false; // å¤ªçŸ­
                    if (line.length > 300) return false; // å¤ªé•¿ï¼ˆå¯èƒ½æ˜¯æ‘˜è¦ï¼‰
                    if (/^(The|This|These|In this|We|Our|Results?|Conclusion|The mature|The results)/i.test(line)) {
                        return false; // æ’é™¤æ‘˜è¦å¸¸è§å¼€å¤´
                    }
                    return true;
                });
                
                console.log('[æ–‡æœ¬æå–] å€™é€‰æ ‡é¢˜è¡Œæ•°:', candidateLines.length);
                console.log('[æ–‡æœ¬æå–] å€™é€‰æ ‡é¢˜è¡Œ:', candidateLines);
                
                if (candidateLines.length > 0) {
                    // é€‰æ‹©ç¬¬ä¸€ä¸ªåˆé€‚çš„å€™é€‰ï¼ˆé€šå¸¸æ˜¯æ ‡é¢˜ï¼‰
                    const candidate = candidateLines[0];
                    // æ¸…ç†Markdownæ ¼å¼
                    const cleanTitle = candidate.replace(/\*\*/g, '').replace(/^#+\s*/, '').trim();
                    if (cleanTitle.length > 10) {
                        result.title = cleanTitle;
                        console.log('[æ–‡æœ¬æå–] âœ“ æ™ºèƒ½è¯†åˆ«åˆ°æ ‡é¢˜:', result.title);
                        titleFound = true;
                    }
                }
            }
            
            if (!titleFound) {
                console.log('[æ–‡æœ¬æå–] âœ— æœªèƒ½æå–åˆ°æ ‡é¢˜');
            }

            // æå–ä½œè€… - å¤šç§ç­–ç•¥ï¼ˆä¼˜å…ˆMarkdownæ ¼å¼ï¼‰
            console.log('[æ–‡æœ¬æå–] å°è¯•æå–ä½œè€…...');
            
            // ç­–ç•¥1: ä¼˜å…ˆè¯†åˆ«Markdownæ ¼å¼çš„ä½œè€… **ä½œè€…**
            let authorFound = false;
            for (const line of lines) {
                // åŒ¹é… **ä½œè€…** æ ¼å¼
                const markdownMatch = line.match(/^\*\*(.+?)\*\*$/);
                if (markdownMatch && markdownMatch[1]) {
                    const candidate = markdownMatch[1].trim();
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä½œè€…æ ¼å¼ï¼ˆåŒ…å«å¤šä¸ªå§“åï¼Œç”¨é€—å·åˆ†éš”ï¼‰
                    const authorPattern = /^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*(?:\s*,\s*[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)+$/;
                    const chineseNamePattern = /^[\u4e00-\u9fa5]+(?:\s*[,ï¼Œ]\s*[\u4e00-\u9fa5]+)+$/;
                    
                    if ((authorPattern.test(candidate) || chineseNamePattern.test(candidate)) &&
                        candidate.length > 5 && candidate.length < 300 &&
                        !/^(ARTICLE INFO|ABSTRACT|Introduction)/i.test(candidate)) {
                        result.authors = candidate;
                        console.log('[æ–‡æœ¬æå–] âœ“ ä»Markdownæ ¼å¼æå–åˆ°ä½œè€…:', result.authors);
                        authorFound = true;
                        break;
                    }
                }
            }
            
            // ç­–ç•¥2: è¯†åˆ«å¸¦æ ‡ç­¾çš„ä½œè€…
            if (!authorFound) {
                const authorPatterns = [
                    /(?:ä½œè€…|Authors?|Author|ç¬¬ä¸€ä½œè€…|First Author|Corresponding Author)[:ï¼š]\s*(.+)/i,
                    /^Author[s]?[:ï¼š]\s*(.+)$/i,
                    /^ä½œè€…[:ï¼š]\s*(.+)$/i
                ];
                
                for (let i = 0; i < authorPatterns.length && !authorFound; i++) {
                    const pattern = authorPatterns[i];
                    for (const line of lines) {
                        const match = line.match(pattern);
                        if (match && match[1]) {
                            result.authors = match[1].trim();
                            console.log('[æ–‡æœ¬æå–] âœ“ ä½¿ç”¨æ ‡ç­¾æ¨¡å¼', i + 1, 'æå–åˆ°ä½œè€…:', result.authors);
                            authorFound = true;
                            break;
                        }
                    }
                }
            }
            
            // ç­–ç•¥3: æ™ºèƒ½è¯†åˆ«ä½œè€…æ ¼å¼ï¼ˆåŒ…å«å¤šä¸ªå§“åï¼Œç”¨é€—å·åˆ†éš”ï¼‰
            if (!authorFound) {
                console.log('[æ–‡æœ¬æå–] å°è¯•æ™ºèƒ½è¯†åˆ«ä½œè€…...');
                const authorNamePattern = /^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*(?:\s*,\s*[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)+$/;
                const chineseNamePattern = /^[\u4e00-\u9fa5]+(?:\s*[,ï¼Œ]\s*[\u4e00-\u9fa5]+)+$/;
                
                for (const line of lines) {
                    // æ¸…ç†Markdownæ ¼å¼
                    const cleanLine = line.replace(/\*\*/g, '').trim();
                    
                    if ((authorNamePattern.test(cleanLine) || chineseNamePattern.test(cleanLine)) && 
                        cleanLine.length > 5 && cleanLine.length < 200 &&
                        !/^(ARTICLE INFO|ABSTRACT|Introduction|School|University|Laboratory)/i.test(cleanLine)) {
                        result.authors = cleanLine;
                        console.log('[æ–‡æœ¬æå–] âœ“ æ™ºèƒ½è¯†åˆ«åˆ°ä½œè€…:', result.authors);
                        authorFound = true;
                        break;
                    }
                }
            }
            
            if (!authorFound) {
                console.log('[æ–‡æœ¬æå–] âœ— æœªèƒ½æå–åˆ°ä½œè€…');
            }

            // æå–æ—¥æœŸ - æ”¹è¿›ç‰ˆæœ¬
            console.log('[æ–‡æœ¬æå–] å°è¯•æå–æ—¥æœŸä¿¡æ¯...');
            
            // é¦–å…ˆæå–æ‰€æœ‰æ—¥æœŸ
            const allDates = [];
            const dateFormats = [
                /(\d{4}[-å¹´/]\d{1,2}[-æœˆ/]\d{1,2})/g,
                /(\d{4}\.\d{1,2}\.\d{1,2})/g,
                /(\d{1,2}[-æœˆ/]\d{1,2}[-æ—¥/]\d{4})/g
            ];
            
            for (const line of lines) {
                for (const format of dateFormats) {
                    const matches = line.matchAll(format);
                    for (const match of matches) {
                        allDates.push({
                            date: match[1],
                            line: line
                        });
                    }
                }
            }
            
            // å»é‡æ—¥æœŸ
            const uniqueDates = [...new Set(allDates.map(d => d.date))];
            console.log('[æ–‡æœ¬æå–] æ‰¾åˆ°çš„æ‰€æœ‰æ—¥æœŸ:', uniqueDates);
            
            // æ ¹æ®å…³é”®è¯åŒ¹é…æ—¥æœŸç±»å‹
            const datePatterns = {
                received: [
                    /(?:æŠ•ç¨¿|Received|Submitted|Submission)[:ï¼š]?\s*(\d{4}[-å¹´/]\d{1,2}[-æœˆ/]\d{1,2})/i,
                    /(?:æŠ•ç¨¿|Received|Submitted|Submission)[:ï¼š]?\s*(\d{4}\.\d{1,2}\.\d{1,2})/i
                ],
                revised: [
                    /(?:ä¿®æ”¹|Revised|Revision|Resubmitted)[:ï¼š]?\s*(\d{4}[-å¹´/]\d{1,2}[-æœˆ/]\d{1,2})/i,
                    /(?:ä¿®æ”¹|Revised|Revision|Resubmitted)[:ï¼š]?\s*(\d{4}\.\d{1,2}\.\d{1,2})/i
                ],
                accepted: [
                    /(?:æ¥å—|Accepted|Acceptance)[:ï¼š]?\s*(\d{4}[-å¹´/]\d{1,2}[-æœˆ/]\d{1,2})/i,
                    /(?:æ¥å—|Accepted|Acceptance)[:ï¼š]?\s*(\d{4}\.\d{1,2}\.\d{1,2})/i
                ],
                available_online: [
                    /(?:åœ¨çº¿|Available Online|Published Online|Online)[:ï¼š]?\s*(\d{4}[-å¹´/]\d{1,2}[-æœˆ/]\d{1,2})/i,
                    /(?:åœ¨çº¿|Available Online|Published Online|Online)[:ï¼š]?\s*(\d{4}\.\d{1,2}\.\d{1,2})/i
                ]
            };

            for (const [key, patterns] of Object.entries(datePatterns)) {
                let found = false;
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        let dateStr = match[1].trim();
                        // æ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼
                        dateStr = normalizeDate(dateStr);
                        result.dates[key] = dateStr;
                        console.log('[æ–‡æœ¬æå–] âœ“ æå–åˆ°', key, 'æ—¥æœŸ:', result.dates[key]);
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    console.log('[æ–‡æœ¬æå–] âœ— æœªæ‰¾åˆ°', key, 'æ—¥æœŸ');
                }
            }
            
            // å¦‚æœåªæ‰¾åˆ°é‡å¤çš„æ—¥æœŸï¼Œå°è¯•æ™ºèƒ½åˆ†é…
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ—¥æœŸå­—æ®µéƒ½ä¸ºç©ºï¼Œä¸”æ‰¾åˆ°äº†æ—¥æœŸ
            const allDatesEmpty = !result.dates.received && !result.dates.revised && 
                                 !result.dates.accepted && !result.dates.available_online;
            
            if (allDatesEmpty && uniqueDates.length > 0) {
                console.log('[æ–‡æœ¬æå–] å°è¯•æ™ºèƒ½åˆ†é…æ—¥æœŸï¼ˆæ‰€æœ‰æ—¥æœŸå­—æ®µéƒ½ä¸ºç©ºï¼‰...');
                const dateKeys = ['received', 'revised', 'accepted', 'available_online'];
                
                // å¦‚æœåªæœ‰ä¸€ä¸ªå”¯ä¸€æ—¥æœŸï¼Œåˆ†é…ç»™acceptedï¼ˆæœ€å¸¸è§çš„ï¼‰
                if (uniqueDates.length === 1) {
                    const dateStr = normalizeDate(uniqueDates[0]);
                    result.dates.accepted = dateStr;
                    console.log('[æ–‡æœ¬æå–] æ™ºèƒ½åˆ†é…å”¯ä¸€æ—¥æœŸåˆ°accepted:', dateStr);
                } else {
                    // å¤šä¸ªæ—¥æœŸï¼ŒæŒ‰é¡ºåºåˆ†é…
                    let dateIndex = 0;
                    for (const key of dateKeys) {
                        if (dateIndex < uniqueDates.length) {
                            const dateStr = normalizeDate(uniqueDates[dateIndex]);
                            result.dates[key] = dateStr;
                            console.log('[æ–‡æœ¬æå–] æ™ºèƒ½åˆ†é…', key, 'æ—¥æœŸ:', dateStr);
                            dateIndex++;
                        }
                    }
                }
            }
            
            console.log('[æ–‡æœ¬æå–] æ–‡æœ¬æå–å®Œæˆ');
        }

        // æ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼
        function normalizeDate(dateStr) {
            console.log('[æ—¥æœŸæ ‡å‡†åŒ–] åŸå§‹æ—¥æœŸ:', dateStr);
            
            // æ›¿æ¢ä¸­æ–‡æ—¥æœŸåˆ†éš”ç¬¦
            let normalized = dateStr.replace(/å¹´|æœˆ|æ—¥/g, '-');
            normalized = normalized.replace(/[\/\.]/g, '-');
            
            // ç§»é™¤æœ«å°¾çš„è¿å­—ç¬¦
            normalized = normalized.replace(/-+$/, '');
            
            // ç¡®ä¿æ ¼å¼ä¸º YYYY-MM-DD
            const parts = normalized.split('-').filter(p => p);
            if (parts.length === 3) {
                const year = parts[0].padStart(4, '0');
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                normalized = `${year}-${month}-${day}`;
            } else if (parts.length === 2) {
                // å¦‚æœåªæœ‰å¹´æœˆï¼Œè¡¥å……æ—¥æœŸä¸º01
                const year = parts[0].padStart(4, '0');
                const month = parts[1].padStart(2, '0');
                normalized = `${year}-${month}-01`;
            }
            
            console.log('[æ—¥æœŸæ ‡å‡†åŒ–] æ ‡å‡†åŒ–å:', normalized);
            return normalized;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(result) {
            console.log('=== å¼€å§‹æ˜¾ç¤ºç»“æœ ===');
            console.log('[ç»“æœæ˜¾ç¤º] å‡†å¤‡æ¸²æŸ“è¯†åˆ«ç»“æœåˆ°é¡µé¢');
            
            let html = '';

            // æ ‡é¢˜
            html += `
                <div class="result-item">
                    <div class="result-label">ğŸ“ è®ºæ–‡æ ‡é¢˜</div>
                    <div class="result-value ${!result.title ? 'empty' : ''}">
                        ${result.title || 'æœªè¯†åˆ«åˆ°æ ‡é¢˜'}
                    </div>
                </div>
            `;
            console.log('[ç»“æœæ˜¾ç¤º] æ ‡é¢˜:', result.title || '(æœªæ‰¾åˆ°)');

            // ä½œè€…
            html += `
                <div class="result-item">
                    <div class="result-label">ğŸ‘¤ ä½œè€…ä¿¡æ¯</div>
                    <div class="result-value ${!result.authors ? 'empty' : ''}">
                        ${result.authors || 'æœªè¯†åˆ«åˆ°ä½œè€…'}
                    </div>
                </div>
            `;
            console.log('[ç»“æœæ˜¾ç¤º] ä½œè€…:', result.authors || '(æœªæ‰¾åˆ°)');

            // æ—¥æœŸ
            html += `
                <div class="result-item">
                    <div class="result-label">ğŸ“… æ—¥æœŸä¿¡æ¯</div>
                    <div class="dates-grid">
                        <div class="date-item">
                            <div class="date-label">æŠ•ç¨¿æ—¥æœŸ (Received)</div>
                            <div class="date-value ${!result.dates.received ? 'empty' : ''}">
                                ${result.dates.received || 'æœªæ‰¾åˆ°'}
                            </div>
                        </div>
                        <div class="date-item">
                            <div class="date-label">ä¿®æ”¹æ—¥æœŸ (Revised)</div>
                            <div class="date-value ${!result.dates.revised ? 'empty' : ''}">
                                ${result.dates.revised || 'æœªæ‰¾åˆ°'}
                            </div>
                        </div>
                        <div class="date-item">
                            <div class="date-label">æ¥å—æ—¥æœŸ (Accepted)</div>
                            <div class="date-value ${!result.dates.accepted ? 'empty' : ''}">
                                ${result.dates.accepted || 'æœªæ‰¾åˆ°'}
                            </div>
                        </div>
                        <div class="date-item">
                            <div class="date-label">åœ¨çº¿å‘è¡¨æ—¥æœŸ (Available Online)</div>
                            <div class="date-value ${!result.dates.available_online ? 'empty' : ''}">
                                ${result.dates.available_online || 'æœªæ‰¾åˆ°'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            console.log('[ç»“æœæ˜¾ç¤º] æ—¥æœŸä¿¡æ¯:', result.dates);

            // åŸå§‹æ–‡æœ¬ï¼ˆå¯æŠ˜å ï¼‰
            html += `
                <div class="result-item">
                    <div class="result-label">ğŸ“„ åŸå§‹è¯†åˆ«æ–‡æœ¬</div>
                    <div class="toggle-raw" onclick="toggleRawText()">ç‚¹å‡»å±•å¼€/æ”¶èµ·</div>
                    <div class="raw-text" id="rawText" style="display: none;">${escapeHtml(result.rawText)}</div>
                </div>
            `;

            resultContent.innerHTML = html;
            resultSection.style.display = 'block';
            console.log('[ç»“æœæ˜¾ç¤º] ç»“æœå·²æ¸²æŸ“åˆ°é¡µé¢');
            console.log('=== ç»“æœæ˜¾ç¤ºå®Œæˆ ===');
            showMessage('è¯†åˆ«å®Œæˆï¼', 'success');
        }

        // åˆ‡æ¢åŸå§‹æ–‡æœ¬æ˜¾ç¤º
        function toggleRawText() {
            const rawText = document.getElementById('rawText');
            if (rawText) {
                rawText.style.display = rawText.style.display === 'none' ? 'block' : 'none';
            }
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¸…ç©º
        function handleClear() {
            console.log('=== æ¸…ç©ºæ‰€æœ‰æ•°æ® ===');
            currentFile = null;
            currentImageData = null;
            fileInput.value = '';
            previewSection.style.display = 'none';
            resultSection.style.display = 'none';
            recognizeBtn.disabled = true;
            showMessage('', '');
            console.log('[æ¸…ç©º] æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            if (!message) {
                messageArea.innerHTML = '';
                messageArea.style.display = 'none';
                return;
            }

            messageArea.innerHTML = `<div class="${type}">${escapeHtml(message)}</div>`;
            messageArea.style.display = 'block';
        }
    </script>
</body>
</html>
